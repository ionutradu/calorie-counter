<html>
<head>
  	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/smoothness/jquery-ui.css" />
  	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="raphael-2.1.4.min.js"></script>
    <script src="justgage.js"></script>
    <base href="http://bootstrapstudio.io/demo/" bs-system-element="" bs-hidden="">
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main page</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style bs-system-element="">.custom-header{
  background:#292c2f;
  padding:20px 40px;
  box-sizing:border-box;
  border:0;
  border-radius:0;
}

.custom-header a.navbar-brand.navbar-link{
  color:#fff;
  font:normal 28px Cookie, Arial, Helvetica, sans-serif;
  line-height:0.5;
  margin-right:40px;
  background:#292c2f;
}

#g1 {
  width:400px; height:320px;
  display: inline-block;
  margin: 1em;
}

.custom-header a.navbar-brand.navbar-link span{
  color:#bc40df;
}

.custom-header ul.nav.navbar-nav.links li a{
  font:14px Arial, Helvetica, sans-serif;
  opacity:0.9;
  text-decoration:none;
  color:#fff;
  background:#292c2f;
  border:0;
}

.custom-header ul.nav.navbar-nav li a:hover{
  opacity:1;
}

.custom-header .badge{
  position:absolute;
  top:4px;
  border-radius:2px;
  font-size:11px;
  color:#fff;
  background-color:#2A6A92;
  padding:2px 4px;
  font-weight:normal;
}

.custom-header li.dropdown, .custom-header li.dropdown.open{
  background:#3a3c3e;
}

.custom-header li.dropdown .dropdown-toggle{
  border-radius:2px;
  color:#fff;
  padding:8px 14px;
  background:#3a3c3e;
  opacity:0.9;
  border:0;
  margin:0;
}

.custom-header li.dropdown .dropdown-toggle:focus, .custom-header li.dropdown .dropdown-toggle:hover, .custom-header li.dropdown .dropdown-toggle:active{
  background:#3a3c3e;
  color:#fff;
}

.custom-header ul.nav.navbar-nav.navbar-right .dropdown li a{
  font:bold 13px Arial, Helvetica, sans-serif;
}

img.dropdown-image{
  border-radius:50%;
  width:32px;
  margin-left:10px;
}

.custom-header .dropdown ul{
  background-color:#3a3c3e;
  border:0;
  min-width:140px;
}

.custom-header .dropdown ul li{
  background-color:#3a3c3e;
  padding:7px;
  text-align:center;
}

.custom-header .dropdown ul li a{
  background:#3a3c3e;
  border-radius:2px;
  color:#fff;
  padding:0;
}

.custom-header .dropdown ul li a:active, .custom-header .dropdown ul li a:focus, .custom-header .dropdown ul li a:hover{
  background:#3a3c3e;
}

.custom-header .dropdown ul li.active a{
  color:#e9ac09 !important;
}

#devices {
    overflow: scroll;
    height: 5000px; 
    margin-bottom: 50px;
    position: left;
    width: 30%;
}

.gauge {
    width: 320px;
    height: 240px;
}

.pre-scrollable {
    max-height: 1000px;
}

.gauge {
    display: inline-block;
}


    </style>
    <style bs-system-element="" bs-hidden=""></style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cookie">
</head>
<body>
<nav class="navbar navbar-default custom-header">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="#" class="navbar-brand navbar-link">
                <inline-character class="space"></inline-character>
            </a>
        </div>
        <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="nav navbar-nav links">
                <li id="history" role="presentation">
                    <a>
                        <inline-character>Home</inline-character>
                    </a>
                </li>
                <li role="presentation">
                    <a href="#" class="hidden">
                        <inline-character class="space"></inline-character>
                    </a>
                </li>
                <li role="presentation">
                    <a href="#" class="hidden custom-navbar">
                        <inline-character class="space"></inline-character>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<br>

<div id="page" style="width: 100%">
    <div id="left1" align="left" style="width: 20%; float:left">
        <form id="person">
            <label for="weight">Weight </label> <br>
            <input type="text" name="weight" id="weight" value="65" width="30"><br><br>
            <label for="age">Age </label><br>
            <input type="text" name="age" id="age" value="25"><br><br>
            <label for="exerciseDuration">Exercise time (min) </label><br>
            <input type="text" name="exerciseDuration" id="exerciseDuration" value="5"><br><br>
            <label for="sex">Sex </label> <br>
            <label for="male"> Male </label>
            <input type="radio" name="gender" id="male" value="male" checked="checked">
            <label for="female"> Female </label>
            <input type="radio" name="gender" id="female" value="female"><br><br>
            <label for="code"> Pairing code </label><br>
            <input type="text" name="code" id="code" value="A" required><br>
        </form>

        Devices nearby: <br>

        <div id="devices" class="pre-scrollable" align="left" style="width: 70%"></div>
    </div>

    <div id="right" align="left" style="width: 80%; float:right">
        <div>
            <button id="pair" onclick="pair()"/>
            Pair
        </div>
        <div>
            <button id="start" onclick="start()"/>
            Start
        </div>
        <div>
            <button id="stop" onclick="stop()"/>
            Stop
        </div>
        <div>
		    <div id="calories" class="gauge"></div>
		    <div id="time" class="gauge"></div>
		    <div id="heartRate" class="gauge"></div>
        </div>
    </div>
    <br style="clear:both;"/>
</div>

<div id="results" title="Exercise results">
    <p id="p1">Calories: </p>
    <p id="p2">Time: </p>
    <p id="p3">Calories per minute: </p>
    <p id="p4">Average heart rate: </p>
</div>

<script>
    var g1;
    var g2;
    var g3;

calories = new JustGage({
    id: "calories",
    value: 0,
    min: 0,
    max: 500,
    gaugeWidthScale: 0.5,
    counter: true,
    hideInnerShadow: true,
    title: "Calories"
});

time = new JustGage({
    id: "time",
    value: 0,
    min: 0,
    max: 100,
    symbol: '%',
    gaugeWidthScale: 0.5,
    counter: true,
    hideInnerShadow: true,
    title: "Sport time"
});

heartRate = new JustGage({
    id: "heartRate",
    value: 0,
    min: 50,
    max: 120,
    gaugeWidthScale: 0.5,
    counter: true,
    hideInnerShadow: true,
    title: "Heart rate (bpm)"
});

    var name = "firstsmartwatch"

    var server_url = "http://localhost:9023/api/smartwatch/"

    var selected = null

    var age, gender, weight, code, exerciseDuration;

    var interval;

    var updateListInterval = setInterval(update_smartwatches_list, 500)
    update_smartwatches_list()

    $("#results").hide()
    $("#pair").hide()
    $("#start").hide()
    $("#stop").hide()

    jQuery.ajaxSetup({async:false});

    function update_smartwatches_list() {
      console.log("Updating smartwatches list")
      console.log(selected)

      devices = ""

      $.get(server_url, function(data, status, xhr) {
          data.forEach(function(entry) {
            console.log("Adding " + entry)
            devices += "<div id=" + entry + " onclick=\"clicked(" + entry + ")\"><pre><font color=black>" + entry + " (paired)" + "</pre></font></div>"
          })
      }, "json");

      $.get(server_url + "/waiting", function(data, status, xhr) {
          data.forEach(function(entry) {
            console.log("Adding " + entry)
            devices += "<div id=" + entry + " onclick=\"clicked(" + entry + ")\"><pre><font color=black>" + entry + " (not paired)" + "</pre></font></div>"
          })
      }, "json");

      console.log(devices)

      $("#devices").html(devices)

      if (selected != null) {
      	console.log("changing color to selected" + selected.id)
      	changeColorToSelectedById(selected.id)
      }
    }

    function changeColorToSelectedById(id) {
      $.each( $('#devices'), function(i, left) {
         $('div', left).each(function() {
            html = $(this).html()
            $(this).html(html.replace("green", "black"))

            if ($(this).attr('id').includes(id)) {
	            $(this).html(html.replace("black", "green"))
            }
         });
      })
    }

    function changeColorToSelected(obj) {
      $.each( $('#devices'), function(i, left) {
         $('div', left).each(function() {
            html = $(this).html()
            $(this).html(html.replace("green", "black"))
         });
      })

      html = $(obj).html()
      $(obj).html(html.replace("black", "green"))
      selected = obj
    }

    function show_results(data) {
    	data = JSON.parse(data)
    	console.log(data)
    	console.log("Calories: " + data["calories"])
    	console.log("Time: " + data["time"])
    	console.log("Calories per minute: " + data["caloriesPerMinute"])
    	console.log("Average heart rate: " + data["averageHeartRate"])

    	var val1 = parseFloat(data["calories"]).toFixed(2)
    	var val2 = data["time"]
    	var val3 = parseFloat(data["caloriesPerMinute"]).toFixed(2)
    	var val4 = parseFloat(data["averageHeartRate"]).toFixed(2)
    	$("#p1").html("Calories: " + val1)
    	$("#p2").html("Time: " + val2)
    	$("#p3").html("Calories per minute: " + val3)
    	$("#p4").html("Average heart rate: " + val4)

		$("#results").dialog();
    }

    function hide_widgets() {
    	$("#calories").hide()
    	$("#time").hide()
    	$("#heartRate").hide()
    }

    function show_widgets() {
    	$("#calories").show()
    	$("#time").show()
    	$("#heartRate").show()
        interval = setInterval(update_widgets, 1000)
    }

    function update_widgets() {
		var url = server_url.concat("/calories?")
			.concat("name=").concat(selected.id);

		console.log(url)

		$.get(url, function(data, status, xhr) {
			console.log(data)
			console.log("cal:" + data["calories"])
			console.log("dur: " + data["exercisePercentage"])
			console.log("hr: " + data["heartRate"])
			time.refresh(data["exercisePercentage"]);
			calories.refresh(data["calories"]);
			heartRate.refresh(data["heartRate"]);
		}, "json")
		.fail(function() {
			stop()
		});
    }

    function pair() {
      if (selected) {
        console.log("Pairing " + selected.id)

        var url = server_url.concat("/pair?")
                  .concat("name=")
                  .concat(selected.id)
                  .concat("&")
                  .concat("code=")
                  .concat(document.forms["person"]["code"].value);

        console.log(url)

        $.get(url, function(data, status, xhr) {
            console.log(data)

            if (data.localeCompare("ok") == 0) {
                // warn
                console.log("Successful pairing")
                $("#pair").hide()
                alert("Pairing with " + selected.id + " successful")
            } else {
                console.log(data)
                alert("Error: " + data)
            }
        }, "text")
        .fail(function(e) {
            alert("Error: " + e.responseText)
        });
      }
    }

    function start() {
      if (selected) {
        console.log("Starting " + selected.id)

        var url = server_url.concat("/start?")
                  .concat("name=").concat(selected.id)
                  .concat("&age=").concat(age)
                  .concat("&isMale=").concat($("#male").is(":checked"))
                  .concat("&weight=").concat(weight)
                  .concat("&exerciseDuration=").concat(exerciseDuration);

        console.log(url)

        $.get(url, function(data, status, xhr) {
            console.log(data)

            if (data.localeCompare("ok") == 0) {
                // warn
                console.log("Successful starting")
                alert("Starting exercise")
                $("#pair").hide()
                $("#start").hide()

                show_widgets()

            } else {
                console.log(data)
            }
        }, "text")
        .fail(function(e) {
            alert("Error: " + e.responseText)
        });

        clearInterval(updateListInterval);
      }
    }

    function stop() {
      if (selected) {
        console.log("Stopping " + selected.id)

        var url = server_url.concat("/stop?")
                  .concat("name=")
                  .concat(selected.id);

        console.log(url)

        $.get(url, function(data, status, xhr) {
            console.log("Received results: " + data)
            show_results(data)

            console.log("Successful stopping")
            $("#pair").show()
            $("#start").show()
            clearInterval(interval)
        }, "text")
        .fail(function() {
        	alert("Error stopping")
        })

        setInterval(update_smartwatches_list, 1000)
        clearInterval(interval)
		time.refresh(0);
		calories.refresh(0);
		heartRate.refresh(0);
      }
    }

    function clicked(obj) {
		var isValid = validateForm()

		if (!isValid) {
		return;
		}

    	age = document.forms["person"]["age"].value;
    	gender = document.forms["person"]["gender"].value;
    	weight = document.forms["person"]["weight"].value;
    	code = document.forms["person"]["code"].value;
    	exerciseDuration = document.forms["person"]["exerciseDuration"].value;

 		$("#pair").show()
    	$("#start").show()
   		$("#stop").show()

      	changeColorToSelected(obj)
    }

    function validateForm() {
        var age = document.forms["person"]["age"].value;
        var gender = document.forms["person"]["gender"].value;
        var weight = document.forms["person"]["weight"].value;
        var code = document.forms["person"]["code"].value;
        var exerciseDuration = document.forms["person"]["exerciseDuration"].value;

        var valid = false;
        var checked = false;

        if (!isNaN(age) && age > 0 && !isNaN(weight) && weight > 0 && code != null && code.length > 0 && !isNaN(exerciseDuration) && exerciseDuration > 0) {
            valid = true;
        }

        var radios = document.getElementsByName('gender')

        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
              checked = true;
            }
        };

        if (!valid || !checked) {
          if (isNaN(weight) || weight < 1) {
            alert("Weight not valid");
            return false;
          }

          if (isNaN(age) || age < 1) {
            alert("Age not valid");
            return false;
          }
          
          if (!checked) {
            alert("Gender not selected");
            return false;
          }

          if (code == null || (code != null && code.length == 0)) {
            alert("Code not valid");
            return false;
          }
        }

        return valid && checked;
    }

</script>

</body>

</html>